---
layout:     post
title:      "Spring Annotation"
subtitle:   "Spring系列文章建立在已经对Spring已经有使用经验，这里不讲解怎么使用Spring这些组件，该篇主要讲解Spring Boot的启动过程；"
date: 2017-06-14 12:30:00
author:     "ryan"
header-img: "img/post-bg-02.jpg"
---

# 1. Spring Boot启动流程

![Spring-Boot](/Users/ryan/Desktop/Spring-Boot.jpg)

该启动流程，图中只给出了重要的步骤，下面会再用文字给大家具体阐述一下该流程；

## 2.1 Set Env Web or Not Web

这一步，在所有启动流程之前就会确定，因为这会影响后续注册Bean Defination的类型，以及中间是否启动一个EmbedTomcat容器的流程；在SpringApplication的initialize方法中会判断javax.servlet.Servlet和org.springframework.web.context.ConfigurableWebApplicationContext这两个类是否在已经加载的JAR中是否存在，如果存在，这次Spring Application的启动环境就是Web环境；



## 2.2 Create Application Context

这步会创建一个ApplicationContext，如果是Web环境，那么就创建AnnotationConfigEmbeddedWebApplicationContext，如果是非Web环境就创建AnnotationConfigApplicationContext，并初始化一些必要的BeanFactoryPostProcessor和BeanPostProcessor，如：注册Bean定义的ConfigurationClassPostProcessor，注册@Value和@Autowired成员域值的AutowiredAnnotationBeanPostProcessor定义等等；



## 2.3 Reg Source to Context

显示调用BeanDefinitionReaderUtils.registerBeanDefinition将Source(我们项目就是启动类Applicaton.class)注册到SpringContext里面去，在Source上的注解@ImportResource/@ComponentScan/@EnableAutoConfiguration会在后续的Reg Bean to Context被一并解析；



## 2.4 Reg Bean to Context

这一步，会将所有的BeanFactoryPostProcessor，以及BeanPostProcessor都注入到SpringContext中去，并调用BeanFactoryPostProcessor的Registry和Post方法。其中最重要的BeanFactoryPostProcessor是ConfigurationClassPostProcessor的Registry方法，他会将Application.class上面的注解进行解析，将@ImportResource的xml，使用@ComponentScan中的包扫描所有@Component/@Bean注册到SpringContext中，基本这一步就基本完成了所有需要BeanDefinition的注册；



## 2.5 Init Embed Tomcat

这一步，只有在Web环境下才会调用，他会创建一个Servlet的Web容器服务，来Host我们Spring MVC应用的调用；



## 2.6 Create Bean from Reg Info

这一步，是Bean生命周期中最重要的一步，将根据之前注册的BeanDefinition进行创建Bean Instance，注入成员域，创建Proxy AOP代理等，我们会在下面一章节中进行介绍；



## 2.7 Applicaton Run Completed

这步算是收尾工作，主要就是publish一些Run Completed的事件，比如在Web环境下，Embed Tomcat在这一步进行start，然后publish一个Embed Tomcat Started的事件；

## 2.8 ApplicationListener

该模式在大多数Java框架都会看到，这个是典型的观察者模式的设计，SpringApplicationListener可以由META-INFO中的spring-factories进行配置，也可以在Spring程序自定义的代码中进行，如下：

```java
//响应事件
springContext.addApplicationListener(listener);
//发布事件
springContext.publishEvent(event);
```

上面那个启动流程图中有一系列的响应事件，必须配置在spring-factories才能在这个流程中被使用，因为springContext还没有初始化出来，整个启动流程已经开始，所以只能通过spring-factories配置来解决；启动完以后，这些spring-factories会调用springContext.addApplicationListener加入到启动后的运行流程中；其中启动流程中典型应用就是我们application.properies的加载，会在ConfigFileApplicationListener的environmentPrepared进行加载；



# 2. Bean Life Cycle

![Bean Life Cycle](/Users/ryan/Desktop/Bean Life Cycle.jpg)